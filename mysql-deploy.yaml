# =========================================================
# 1. SECRET : Pour stocker le mot de passe "root" en s√©curit√©
# =========================================================
apiVersion: v1
kind: Secret
metadata:
  name: farm-mysql-secret
type: Opaque
stringData:
  # Kubernetes va encoder √ßa tout seul.
  ROOT_PASSWORD: "root"

---
# =========================================================
# 2. PVC : Pour ne pas perdre les donn√©es si le Pod red√©marre
# =========================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: farm-mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      # 1Go est suffisant pour le d√©veloppement
      storage: 1Gi
  # On laisse Kubernetes utiliser le stockage par d√©faut du cluster (hostPath ou cloud)

---
# =========================================================
# 3. SERVICE : L'adresse r√©seau interne (DNS)
# =========================================================
apiVersion: v1
kind: Service
metadata:
  name: farm-mysql-service
spec:
  type: ClusterIP
  selector:
    app: farm-mysql-service
  ports:
    - port: 3306
      targetPort: 3306

---
# =========================================================
# 4. DEPLOYMENT : Le conteneur MySQL lui-m√™me
# =========================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: farm-mysql-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: farm-mysql-service
  template:
    metadata:
      labels:
        app: farm-mysql-service
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          imagePullPolicy: IfNotPresent

          # ‚úÖ INDISPENSABLE : Pour √©viter les erreurs de connexion "Public Key Retrieval"
          # avec les connecteurs Java Spring Boot.
          args: ["--default-authentication-plugin=mysql_native_password"]

          ports:
            - containerPort: 3306

          env:
            # On r√©cup√®re le mot de passe depuis le SECRET d√©fini en haut
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: farm-mysql-secret
                  key: ROOT_PASSWORD

            # üí° Note : On ne d√©finit pas MYSQL_DATABASE ici.
            # Vos services Spring Boot cr√©eront 'db-projet' et 'db-equipment'
            # eux-m√™mes gr√¢ce √† l'option JDBC 'createDatabaseIfNotExist=true'.

          # ‚úÖ SONDE DE DISPONIBILIT√â :
          # Kubernetes n'enverra pas de trafic tant que MySQL n'est pas pr√™t.
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5

          volumeMounts:
            - name: mysql-storage
              mountPath: /var/lib/mysql

      volumes:
        - name: mysql-storage
          persistentVolumeClaim:
            claimName: farm-mysql-pvc